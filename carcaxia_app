import React, { useState } from 'react';

/**
 * Código revertido sin uso de logo ni dependencia de estilos externos.
 * Conservamos la lógica, pero eliminamos referencias al componente Logo
 * y todo lo relacionado con Tailwind.
 *
 * Cambiamos el título "V Foliada Carcaxía" para ser un encabezado destacado.
 *
 * Test Cases:
 * 1. Verificar que se puede renderizar sin errores y sin un logo.
 * 2. Comprobar que el título se ve grande y visible.
 * 3. Asegurar que las funcionalidades de Usuario/Admin se mantienen.
 * 4. Inscribirse/Cancelar.
 * 5. Modo Admin: Editar/Gardar/X.
 */

// BLOQUES DE INSCRICIÓN
const BLOCKS = [
  { name: 'Foliadiña', start: 1, end: 8 },
  { name: 'Obradoiro de Baile', start: 9, end: 8 }, // end < start => no filas
  { name: 'Foliada', start: 9, end: 16 },
  { name: 'Grupo Sorpresa', start: 17, end: 32 }
];

function App() {
  // ESTADOS
  const [isAdmin, setIsAdmin] = useState(false);
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [showLoginDialog, setShowLoginDialog] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  // Para o formulario de login
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginError, setLoginError] = useState('');

  // Táboa de rexistros
  const [registrations, setRegistrations] = useState(
    Array(32).fill(null).map(() => ({
      nomeGrupo: '',
      asociacion: '',
      integrantes: '',
      registered: false,
      editing: false
    }))
  );

  // Notificacións
  const [notification, setNotification] = useState({ show: false, message: '', type: '' });

  // MOSTRAR NOTIFICACIÓN
  const showNotification = (message, type) => {
    setNotification({ show: true, message, type });
    setTimeout(() => {
      setNotification({ show: false, message: '', type: '' });
    }, 3000);
  };

  // AUTENTICACIÓN
  const handleLogin = () => {
    if (loginForm.username === 'Carcaxía' && loginForm.password === 'Carcaxia2003*') {
      setIsAdmin(true);
      setShowLoginDialog(false);
      setLoginForm({ username: '', password: '' });
      setLoginError('');
      showNotification('Sesión iniciada correctamente', 'success');
    } else {
      setLoginError('Usuario ou contrasinal incorrectos');
    }
  };

  const handleLogout = () => {
    setIsAdmin(false);
    showNotification('Sesión pechada correctamente', 'success');
  };

  // MANEJO DE INPUTS
  const handleInputChange = (index, field, value) => {
    // Si no eres admin y ese slot ya está inscrito, no permitimos editar
    if (!isAdmin && registrations[index].registered) return;

    setRegistrations(prev => {
      const newRegistrations = [...prev];
      if (field === 'integrantes') {
        value = value.replace(/\D/g, '');
        if (value === '' || parseInt(value) <= 0) {
          value = '';
        }
      }
      newRegistrations[index] = {
        ...newRegistrations[index],
        [field]: value
      };
      return newRegistrations;
    });
  };

  // COMPROBA SE FALTAN CAMPOS PARA USUARIO
  const isRowComplete = (index) => {
    const row = registrations[index];
    return (
      row.nomeGrupo.trim() !== '' &&
      row.asociacion.trim() !== '' &&
      row.integrantes !== ''
    );
  };

  // INSCRIBIR / CANCELAR (usuario)
  const handleRegisterClick = (index) => {
    if (!isAdmin && !isRowComplete(index)) {
      showNotification('Debes cubrir tódolos campos antes de inscribirte', 'error');
      return;
    }
    setSelectedRow(index);
    setShowConfirmDialog(true);
  };

  const handleRegister = (index) => {
    setRegistrations(prev => {
      const newRegistrations = [...prev];
      if (prev[index].registered) {
        // Cancelar
        newRegistrations[index] = {
          ...newRegistrations[index],
          nomeGrupo: '',
          asociacion: '',
          integrantes: '',
          registered: false
        };
      } else {
        // Inscribir
        newRegistrations[index] = {
          ...newRegistrations[index],
          registered: true
        };
      }
      return newRegistrations;
    });

    const wasRegistered = registrations[index].registered;
    const message = wasRegistered ? 'Cancelouse a inscrición' : 'Rexistrado correctamente';
    showNotification(message, wasRegistered ? 'error' : 'success');
    setShowConfirmDialog(false);
  };

  // FUNCIONS DE ADMIN
  const handleAdminEdit = (index) => {
    setRegistrations(prev => {
      const newRegistrations = [...prev];
      newRegistrations[index].editing = true;
      return newRegistrations;
    });
  };

  const handleAdminSave = (index) => {
    setRegistrations(prev => {
      const newRegistrations = [...prev];
      newRegistrations[index].editing = false;
      const row = newRegistrations[index];
      // Si hay datos, lo marcamos como registered
      if (
        row.nomeGrupo.trim() !== '' ||
        row.asociacion.trim() !== '' ||
        row.integrantes !== ''
      ) {
        newRegistrations[index].registered = true;
      } else {
        newRegistrations[index].registered = false;
      }
      return newRegistrations;
    });
  };

  const handleAdminDelete = (index) => {
    setRegistrations(prev => {
      const newRegistrations = [...prev];
      newRegistrations[index] = {
        nomeGrupo: '',
        asociacion: '',
        integrantes: '',
        registered: false,
        editing: false
      };
      return newRegistrations;
    });
    showNotification('Rexistro eliminado', 'success');
  };

  // RENDERIZA LA TÁBOA
  const renderTableRows = () => {
    return BLOCKS.flatMap(block => {
      const blockHeader = (
        <tr key={`block-${block.name}`} style={{ backgroundColor: '#e3f2fd', fontWeight: 'bold' }}>
          <td colSpan={5} style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>
            {block.name}
          </td>
        </tr>
      );

      const rows = [blockHeader];

      if (block.end >= block.start) {
        for (let i = block.start - 1; i < block.end; i++) {
          const rowData = registrations[i];
          const isRegisteredAndNotAdmin = !isAdmin && rowData.registered;

          // Determina color de fondo
          let backgroundColor = '#ffffff';
          if (rowData.registered) {
            backgroundColor = isAdmin ? '#e8f5e9' : '#ffebee';
          }

          rows.push(
            <tr key={`registration-${i}`} style={{ backgroundColor, border: '1px solid #ddd' }}>
              <td style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>{i + 1}</td>

              {isAdmin ? (
                rowData.editing ? (
                  <>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      <input
                        type="text"
                        value={rowData.nomeGrupo}
                        onChange={(e) => handleInputChange(i, 'nomeGrupo', e.target.value)}
                        style={{ width: '100%', padding: '8px', borderRadius: '4px', border: '1px solid #ddd' }}
                        placeholder="Nome do grupo..."
                      />
                    </td>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      <input
                        type="text"
                        value={rowData.asociacion}
                        onChange={(e) => handleInputChange(i, 'asociacion', e.target.value)}
                        style={{ width: '100%', padding: '8px', borderRadius: '4px', border: '1px solid #ddd' }}
                        placeholder="Asociación..."
                      />
                    </td>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      <input
                        type="number"
                        value={rowData.integrantes}
                        onChange={(e) => handleInputChange(i, 'integrantes', e.target.value)}
                        style={{ width: '100%', padding: '8px', borderRadius: '4px', border: '1px solid #ddd' }}
                        placeholder="Nº..."
                      />
                    </td>
                    <td style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>
                      <button
                        onClick={() => handleAdminSave(i)}
                        style={{
                          padding: '8px 16px',
                          border: 'none',
                          cursor: 'pointer',
                          backgroundColor: '#4CAF50',
                          color: 'white',
                          marginRight: '8px',
                          borderRadius: '4px'
                        }}
                      >
                        Gardar
                      </button>
                      {rowData.registered && (
                        <button
                          onClick={() => handleAdminDelete(i)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '4px',
                            border: 'none',
                            cursor: 'pointer',
                            backgroundColor: '#f44336',
                            color: 'white'
                          }}
                        >
                          X
                        </button>
                      )}
                    </td>
                  </>
                ) : (
                  <>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      {rowData.nomeGrupo || <span style={{ color: '#aaa' }}>(Baleiro)</span>}
                    </td>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      {rowData.asociacion || <span style={{ color: '#aaa' }}>(Baleiro)</span>}
                    </td>
                    <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                      {rowData.integrantes || <span style={{ color: '#aaa' }}>(Baleiro)</span>}
                    </td>
                    <td style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>
                      <button
                        onClick={() => handleAdminEdit(i)}
                        style={{
                          padding: '8px 16px',
                          border: 'none',
                          cursor: 'pointer',
                          backgroundColor: '#2196F3',
                          color: 'white',
                          marginRight: '8px',
                          borderRadius: '4px'
                        }}
                      >
                        Editar
                      </button>
                      {rowData.registered && (
                        <button
                          onClick={() => handleAdminDelete(i)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '4px',
                            border: 'none',
                            cursor: 'pointer',
                            backgroundColor: '#f44336',
                            color: 'white'
                          }}
                        >
                          X
                        </button>
                      )}
                    </td>
                  </>
                )
              ) : (
                // MODO USUARIO
                <>
                  <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                    {isRegisteredAndNotAdmin ? (
                      <div style={{ textAlign: 'center', color: '#666' }}>Reservado</div>
                    ) : (
                      <input
                        type="text"
                        value={rowData.nomeGrupo}
                        onChange={(e) => handleInputChange(i, 'nomeGrupo', e.target.value)}
                        style={{
                          width: '100%',
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #ddd'
                        }}
                        disabled={isRegisteredAndNotAdmin}
                        placeholder="Nome do grupo..."
                      />
                    )}
                  </td>
                  <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                    {isRegisteredAndNotAdmin ? (
                      <div style={{ textAlign: 'center', color: '#666' }}>Reservado</div>
                    ) : (
                      <input
                        type="text"
                        value={rowData.asociacion}
                        onChange={(e) => handleInputChange(i, 'asociacion', e.target.value)}
                        style={{
                          width: '100%',
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #ddd'
                        }}
                        disabled={isRegisteredAndNotAdmin}
                        placeholder="Asociación..."
                      />
                    )}
                  </td>
                  <td style={{ padding: '12px', border: '1px solid #ddd' }}>
                    {isRegisteredAndNotAdmin ? (
                      <div style={{ textAlign: 'center', color: '#666' }}>Reservado</div>
                    ) : (
                      <input
                        type="number"
                        value={rowData.integrantes}
                        onChange={(e) => handleInputChange(i, 'integrantes', e.target.value)}
                        style={{
                          width: '100%',
                          padding: '8px',
                          borderRadius: '4px',
                          border: '1px solid #ddd'
                        }}
                        disabled={isRegisteredAndNotAdmin}
                        min="1"
                        placeholder="Nº..."
                      />
                    )}
                  </td>
                  <td style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>
                    {isRegisteredAndNotAdmin ? (
                      <div
                        style={{
                          padding: '8px 16px',
                          backgroundColor: '#ffebee',
                          color: '#666',
                          borderRadius: '4px',
                          display: 'inline-block'
                        }}
                      >
                        Ocupado
                      </div>
                    ) : (
                      <button
                        onClick={() => handleRegisterClick(i)}
                        style={{
                          padding: '8px 16px',
                          borderRadius: '4px',
                          border: 'none',
                          cursor: 'pointer',
                          backgroundColor: rowData.registered ? '#f44336' : '#4CAF50',
                          color: 'white'
                        }}
                      >
                        {rowData.registered ? 'Cancelar' : 'Inscribirse'}
                      </button>
                    )}
                  </td>
                </>
              )}
            </tr>
          );
        }
      }

      return rows;
    });
  };

  // Determina se a fila seleccionada está rexistrada
  const isRowRegistered =
    selectedRow !== null &&
    registrations[selectedRow] &&
    registrations[selectedRow].registered;

  return (
    <div style={{ position: 'relative', padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      {/* BOTÓN ADMIN / LOGOUT */}
      <div style={{ position: 'absolute', top: '20px', right: '20px' }}>
        {isAdmin ? (
          <button
            onClick={handleLogout}
            style={{
              padding: '8px 16px',
              borderRadius: '4px',
              border: '1px solid #ddd',
              backgroundColor: 'white',
              cursor: 'pointer',
              opacity: 0.3,
              transition: 'opacity 0.3s'
            }}
            onMouseEnter={(e) => (e.target.style.opacity = 1)}
            onMouseLeave={(e) => (e.target.style.opacity = 0.3)}
          >
            Pechar sesión
          </button>
        ) : (
          <button
            onClick={() => setShowLoginDialog(true)}
            style={{
              padding: '8px 16px',
              borderRadius: '4px',
              border: '1px solid #ddd',
              backgroundColor: 'white',
              cursor: 'pointer',
              opacity: 0.3,
              transition: 'opacity 0.3s'
            }}
            onMouseEnter={(e) => (e.target.style.opacity = 1)}
            onMouseLeave={(e) => (e.target.style.opacity = 0.3)}
          >
            Modo Admin
          </button>
        )}
      </div>

      {notification.show && (
        <div
          style={{
            position: 'fixed',
            top: '20px',
            right: '20px',
            padding: '16px',
            borderRadius: '4px',
            color: 'white',
            zIndex: 1000,
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
            backgroundColor: notification.type === 'success' ? '#4CAF50' : '#f44336'
          }}
        >
          {notification.message}
        </div>
      )}

      {/* DIALOGO LOGIN */}
      {showLoginDialog && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
          }}
        >
          <div
            style={{
              backgroundColor: 'white',
              padding: '20px',
              borderRadius: '8px',
              maxWidth: '500px',
              width: '90%'
            }}
          >
            <h2 style={{ marginBottom: '16px', fontSize: '1.5em', textAlign: 'center', color: '#333' }}>
              Acceso Administrador
            </h2>
            {loginError && (
              <div
                style={{
                  padding: '10px',
                  marginBottom: '15px',
                  backgroundColor: '#ffebee',
                  color: '#c62828',
                  borderRadius: '4px',
                  fontSize: '0.9em',
                  textAlign: 'center'
                }}
              >
                {loginError}
              </div>
            )}

            <div style={{ marginBottom: '15px' }}>
              <input
                type="text"
                placeholder="Usuario"
                value={loginForm.username}
                onChange={(e) => {
                  setLoginForm(prev => ({ ...prev, username: e.target.value }));
                  setLoginError('');
                }}
                style={{
                  width: '100%',
                  padding: '10px',
                  borderRadius: '4px',
                  border: '1px solid #ddd',
                  fontSize: '1em'
                }}
              />
            </div>
            <div style={{ marginBottom: '20px' }}>
              <input
                type="password"
                placeholder="Contrasinal"
                value={loginForm.password}
                onChange={(e) => {
                  setLoginForm(prev => ({ ...prev, password: e.target.value }));
                  setLoginError('');
                }}
                style={{
                  width: '100%',
                  padding: '10px',
                  borderRadius: '4px',
                  border: '1px solid #ddd',
                  fontSize: '1em'
                }}
              />
            </div>

            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
              <button
                onClick={() => {
                  setShowLoginDialog(false);
                  setLoginForm({ username: '', password: '' });
                  setLoginError('');
                }}
                style={{
                  padding: '8px 16px',
                  borderRadius: '4px',
                  border: '1px solid #ddd',
                  backgroundColor: 'white',
                  cursor: 'pointer'
                }}
              >
                Cancelar
              </button>
              <button
                onClick={handleLogin}
                style={{
                  padding: '8px 16px',
                  borderRadius: '4px',
                  border: 'none',
                  backgroundColor: '#4CAF50',
                  color: 'white',
                  cursor: 'pointer'
                }}
              >
                Acceder
              </button>
            </div>
          </div>
        </div>
      )}

      {/* DIALOGO CONFIRM (USUARIO) */}
      {showConfirmDialog && !isAdmin && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0,0,0,0.5)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            zIndex: 1000
          }}
        >
          <div
            style={{
              backgroundColor: 'white',
              padding: '20px',
              borderRadius: '8px',
              maxWidth: '500px',
              width: '90%'
            }}
          >
            <h2 style={{ marginBottom: '16px', fontSize: '1.5em' }}>
              {isRowRegistered ? 'Confirmar Cancelación' : 'Confirmar Inscrición'}
            </h2>
            <p style={{ marginBottom: '20px' }}>
              {isRowRegistered
                ? 'Estás seguro/a de que queres cancelar esta inscrición?'
                : 'Estás seguro/a de que queres inscribirte nesta posición? Unha vez confirmado, non poderás modificar os datos.'}
            </p>
            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
              <button
                onClick={() => setShowConfirmDialog(false)}
                style={{
                  padding: '8px 16px',
                  borderRadius: '4px',
                  border: '1px solid #ddd',
                  backgroundColor: 'white',
                  cursor: 'pointer'
                }}
              >
                Cancelar
              </button>
              <button
                onClick={() => selectedRow !== null && handleRegister(selectedRow)}
                style={{
                  padding: '8px 16px',
                  borderRadius: '4px',
                  border: 'none',
                  backgroundColor: '#4CAF50',
                  color: 'white',
                  cursor: 'pointer'
                }}
              >
                Confirmar
              </button>
            </div>
          </div>
        </div>
      )}

      <div
        style={{
          backgroundColor: 'white',
          borderRadius: '8px',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
          overflow: 'hidden',
          padding: '20px'
        }}
      >
        <h1
          style={{
            fontSize: '2em',
            marginBottom: '10px',
            textAlign: 'center'
          }}
        >
          V Foliada Carcaxía
        </h1>
        <div style={{ color: '#666', textAlign: 'center', marginBottom: '20px' }}>
          A.C.D. Carcaxía - Dende 2003
        </div>

        <div style={{ overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
            <thead>
              <tr style={{ backgroundColor: '#f5f5f5' }}>
                <th style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>Orde</th>
                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #ddd' }}>Nome do Grupo</th>
                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #ddd' }}>Asociación</th>
                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #ddd' }}>Nº de integrantes</th>
                <th style={{ padding: '12px', textAlign: 'center', border: '1px solid #ddd' }}>Acción</th>
              </tr>
            </thead>
            <tbody>{renderTableRows()}</tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

export default App;
